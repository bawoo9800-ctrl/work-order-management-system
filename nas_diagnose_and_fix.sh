#!/bin/bash

###############################################################################
# ğŸ”§ NAS ì‘ì—…ì§€ì‹œì„œ ì‹œìŠ¤í…œ ì§„ë‹¨ ë° ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸
###############################################################################
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
# 1. MySQL status ì»¬ëŸ¼ì— 'deleted' ê°’ ì¶”ê°€
# 2. ë°±ì—”ë“œ ì„œë²„ ì¬ì‹œì‘ ë° ìƒíƒœ í™•ì¸
# 3. í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì¬ì‹œì‘ ë° ìƒíƒœ í™•ì¸
# 4. ì ‘ì† URL ë° í…ŒìŠ¤íŠ¸ ë°©ë²• ì•ˆë‚´
###############################################################################

echo ""
echo "================================================"
echo "ğŸ”§ NAS ì‘ì—…ì§€ì‹œì„œ ì‹œìŠ¤í…œ ì§„ë‹¨ ë° ë³µêµ¬"
echo "================================================"
echo ""

# í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd /volume1/web/work-order-management-system || exit 1

echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
echo ""

###############################################################################
# 1ë‹¨ê³„: ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
###############################################################################
echo "================================================"
echo "1ï¸âƒ£  ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
echo "================================================"
echo ""

# ì¶©ëŒ íŒŒì¼ ì œê±°
if [ -f "nas_complete_fix.sh" ]; then
    rm -f nas_complete_fix.sh
    echo "âœ… nas_complete_fix.sh ì œê±°ë¨"
fi

if [ -f "nas_restart_frontend.sh" ]; then
    rm -f nas_restart_frontend.sh
    echo "âœ… nas_restart_frontend.sh ì œê±°ë¨"
fi

if [ -f "nas_force_update.sh" ]; then
    rm -f nas_force_update.sh
    echo "âœ… nas_force_update.sh ì œê±°ë¨"
fi

echo ""
echo "ğŸ“¥ Git Pull ì‹¤í–‰ ì¤‘..."
git pull origin main

echo ""
echo "ğŸ“‹ ìµœì‹  ì»¤ë°‹:"
git log --oneline -1

echo ""

###############################################################################
# 2ë‹¨ê³„: MySQL status ì»¬ëŸ¼ ìˆ˜ì •
###############################################################################
echo "================================================"
echo "2ï¸âƒ£  MySQL status ì»¬ëŸ¼ ìˆ˜ì •"
echo "================================================"
echo ""

echo "âš™ï¸  status ì»¬ëŸ¼ì— 'deleted' ê°’ ì¶”ê°€ ì¤‘..."
echo ""

# MySQL ë£¨íŠ¸ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ìš”
mysql -u root -p work_order_management << 'EOF'
-- í˜„ì¬ status ì»¬ëŸ¼ í™•ì¸
SELECT 'Before:' AS status;
SHOW COLUMNS FROM work_orders LIKE 'status';

-- status ENUMì— 'deleted' ì¶”ê°€
ALTER TABLE work_orders 
MODIFY COLUMN status ENUM('pending', 'classified', 'unclassified', 'deleted') 
DEFAULT 'pending';

-- ìˆ˜ì • í›„ í™•ì¸
SELECT 'After:' AS status;
SHOW COLUMNS FROM work_orders LIKE 'status';
EOF

echo ""
echo "âœ… MySQL status ì»¬ëŸ¼ ìˆ˜ì • ì™„ë£Œ"
echo ""

###############################################################################
# 3ë‹¨ê³„: PM2 ìƒíƒœ í™•ì¸
###############################################################################
echo "================================================"
echo "3ï¸âƒ£  PM2 ìƒíƒœ í™•ì¸"
echo "================================================"
echo ""

sudo /usr/local/bin/pm2 status

echo ""

###############################################################################
# 4ë‹¨ê³„: ë°±ì—”ë“œ ì¬ì‹œì‘
###############################################################################
echo "================================================"
echo "4ï¸âƒ£  ë°±ì—”ë“œ ì¬ì‹œì‘"
echo "================================================"
echo ""

cd backend || exit 1
echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
echo ""

# ë°±ì—”ë“œ ì¬ì‹œì‘
echo "ğŸ”„ ë°±ì—”ë“œ ì¬ì‹œì‘ ì¤‘..."
sudo /usr/local/bin/pm2 restart work-order-backend

echo ""
echo "â³ 5ì´ˆ ëŒ€ê¸° ì¤‘..."
sleep 5

echo ""
echo "ğŸ“‹ ë°±ì—”ë“œ ë¡œê·¸ (ìµœê·¼ 30ì¤„):"
sudo /usr/local/bin/pm2 logs work-order-backend --lines 30 --nostream

echo ""
echo "âœ… ë°±ì—”ë“œ ì¬ì‹œì‘ ì™„ë£Œ"
echo ""

###############################################################################
# 5ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œì‘
###############################################################################
echo "================================================"
echo "5ï¸âƒ£  í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œì‘"
echo "================================================"
echo ""

cd /volume1/web/work-order-management-system/frontend || exit 1
echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
echo ""

# í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œì‘
echo "ğŸ”„ í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œì‘ ì¤‘..."
sudo /usr/local/bin/pm2 restart work-order-frontend

echo ""
echo "â³ 5ì´ˆ ëŒ€ê¸° ì¤‘..."
sleep 5

echo ""
echo "ğŸ“‹ í”„ë¡ íŠ¸ì—”ë“œ ë¡œê·¸ (ìµœê·¼ 30ì¤„):"
sudo /usr/local/bin/pm2 logs work-order-frontend --lines 30 --nostream

echo ""
echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œì‘ ì™„ë£Œ"
echo ""

###############################################################################
# 6ë‹¨ê³„: PM2 ìµœì¢… ìƒíƒœ í™•ì¸
###############################################################################
echo "================================================"
echo "6ï¸âƒ£  PM2 ìµœì¢… ìƒíƒœ í™•ì¸"
echo "================================================"
echo ""

sudo /usr/local/bin/pm2 status

echo ""

###############################################################################
# 7ë‹¨ê³„: ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
###############################################################################
echo "================================================"
echo "7ï¸âƒ£  ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸"
echo "================================================"
echo ""

echo "ğŸ” ë°±ì—”ë“œ Health Check (localhost):"
curl -s http://localhost:3200/health || echo "âŒ ë¡œì»¬ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"

echo ""
echo ""

echo "ğŸ” ë°±ì—”ë“œ Health Check (ë„ë©”ì¸):"
curl -s http://api.doorlife.synology.me/health || echo "âŒ ë„ë©”ì¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"

echo ""
echo ""

###############################################################################
# ì™„ë£Œ
###############################################################################
echo "================================================"
echo "âœ… ì§„ë‹¨ ë° ë³µêµ¬ ì™„ë£Œ!"
echo "================================================"
echo ""
echo "ğŸŒ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸:"
echo ""
echo "   1) ë¸Œë¼ìš°ì € ìºì‹œ ì™„ì „ ì‚­ì œ"
echo "      - Ctrl+Shift+Delete (ì „ì²´ ê¸°ê°„ ì„ íƒ)"
echo "      - ì¿ í‚¤ ë° ê¸°íƒ€ ì‚¬ì´íŠ¸ ë°ì´í„° âœ“"
echo "      - ìºì‹œëœ ì´ë¯¸ì§€ ë° íŒŒì¼ âœ“"
echo ""
echo "   2) ê°•ë ¥í•œ ìƒˆë¡œê³ ì¹¨"
echo "      - Ctrl+Shift+R (Windows/Linux)"
echo "      - Cmd+Shift+R (Mac)"
echo ""
echo "   3) ì‹œí¬ë¦¿ ëª¨ë“œ ê¶Œì¥ (Ctrl+Shift+N)"
echo ""
echo "   4) ì ‘ì† URL (ë°˜ë“œì‹œ ë„ë©”ì¸ ì‚¬ìš©!):"
echo "      âœ… http://wo.doorlife.synology.me"
echo "      âŒ http://192.168.0.109:5173 (ì‚¬ìš© ê¸ˆì§€!)"
echo ""
echo "================================================"
echo "ğŸ“Š í™•ì¸ ì‚¬í•­:"
echo "================================================"
echo ""
echo "âœ“ ì¢Œì¸¡ ì‚¬ì´ë“œë°” ì œê±°ë¨"
echo "âœ“ 4ì—´ ê·¸ë¦¬ë“œ (1920x1080)"
echo "âœ“ A4 ë¹„ìœ¨ ì¹´ë“œ (210:297)"
echo "âœ“ ê±°ë˜ì²˜ëª…/í˜„ì¥ëª… í‘œì‹œ"
echo "âœ“ ì•„ì´ì½˜ ë²„íŠ¼ (âœ, âœ“, âœ•)"
echo "âœ“ ë°°ê²½ìƒ‰ #f8f8f8"
echo "âœ“ ì‘ì—…ì§€ì‹œì„œ ì‚­ì œ ì‹œ 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤' ë©”ì‹œì§€"
echo ""
echo "================================================"
echo "ğŸ› ë¬¸ì œê°€ ê³„ì†ë˜ë©´ ë³´ê³ í•´ì£¼ì„¸ìš”:"
echo "================================================"
echo ""
echo "1. PM2 ìƒíƒœ (ìœ„ì˜ ì¶œë ¥ ë³µì‚¬)"
echo "2. ë°±ì—”ë“œ ë¡œê·¸ (ìœ„ì˜ ì¶œë ¥ ë³µì‚¬)"
echo "3. í”„ë¡ íŠ¸ì—”ë“œ ë¡œê·¸ (ìœ„ì˜ ì¶œë ¥ ë³µì‚¬)"
echo "4. ë¸Œë¼ìš°ì € ì½˜ì†” ì—ëŸ¬ (F12 â†’ Console íƒ­)"
echo "5. ë¸Œë¼ìš°ì € ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ (F12 â†’ Network íƒ­)"
echo ""
echo "================================================"
echo ""
