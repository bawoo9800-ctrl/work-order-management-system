#!/bin/bash

###############################################################################
# 🔍 NAS 작업지시서 시스템 빠른 상태 확인
###############################################################################
# PM2 상태, 백엔드/프론트엔드 로그, 네트워크 연결을 빠르게 확인합니다.
###############################################################################

echo ""
echo "================================================"
echo "🔍 NAS 작업지시서 시스템 빠른 상태 확인"
echo "================================================"
echo ""

###############################################################################
# PM2 상태 확인
###############################################################################
echo "📊 PM2 프로세스 상태:"
echo "------------------------------------------------"
sudo /usr/local/bin/pm2 status

echo ""
echo ""

###############################################################################
# 백엔드 로그 (최근 20줄)
###############################################################################
echo "📋 백엔드 로그 (최근 20줄):"
echo "------------------------------------------------"
sudo /usr/local/bin/pm2 logs work-order-backend --lines 20 --nostream

echo ""
echo ""

###############################################################################
# 프론트엔드 로그 (최근 20줄)
###############################################################################
echo "📋 프론트엔드 로그 (최근 20줄):"
echo "------------------------------------------------"
sudo /usr/local/bin/pm2 logs work-order-frontend --lines 20 --nostream

echo ""
echo ""

###############################################################################
# 네트워크 연결 테스트
###############################################################################
echo "🌐 네트워크 연결 테스트:"
echo "------------------------------------------------"

echo ""
echo "1️⃣  백엔드 Health Check (localhost:3200):"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:3200/health

echo ""
echo "2️⃣  백엔드 Health Check (도메인):"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://api.doorlife.synology.me/health

echo ""
echo "3️⃣  백엔드 Clients API (도메인):"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://api.doorlife.synology.me/api/v1/clients

echo ""
echo "4️⃣  프론트엔드 (도메인):"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://wo.doorlife.synology.me

echo ""
echo ""

###############################################################################
# 디스크 사용량 확인 (이미지 저장 경로)
###############################################################################
echo "💾 디스크 사용량 (/volume1/work_orders):"
echo "------------------------------------------------"
if [ -d "/volume1/work_orders" ]; then
    du -sh /volume1/work_orders 2>/dev/null || echo "경로를 읽을 수 없습니다"
    echo ""
    echo "📁 최근 업로드된 파일 (최근 5개):"
    find /volume1/work_orders -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -5 | awk '{print $2}' || echo "파일을 읽을 수 없습니다"
else
    echo "❌ /volume1/work_orders 디렉토리가 존재하지 않습니다"
fi

echo ""
echo ""

###############################################################################
# MySQL 연결 테스트
###############################################################################
echo "🗄️  MySQL 연결 테스트:"
echo "------------------------------------------------"
mysql -u root -p work_order_management -e "SELECT 'MySQL 연결 성공!' AS status; SELECT COUNT(*) AS total_work_orders FROM work_orders; SHOW COLUMNS FROM work_orders LIKE 'status';" 2>/dev/null || echo "❌ MySQL 연결 실패 (비밀번호 입력 필요)"

echo ""
echo ""

###############################################################################
# 요약
###############################################################################
echo "================================================"
echo "✅ 빠른 상태 확인 완료"
echo "================================================"
echo ""
echo "💡 접속 URL (반드시 도메인 사용!):"
echo "   ✅ http://wo.doorlife.synology.me"
echo "   ❌ http://192.168.0.109:5173 (사용 금지!)"
echo ""
echo "🔧 문제가 있다면:"
echo "   bash nas_diagnose_and_fix.sh 실행"
echo ""
